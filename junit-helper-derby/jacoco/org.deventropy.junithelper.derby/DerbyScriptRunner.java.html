<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DerbyScriptRunner.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JUnit Helper :: Derby</a> &gt; <a href="index.source.html" class="el_package">org.deventropy.junithelper.derby</a> &gt; <span class="el_source">DerbyScriptRunner.java</span></div><h1>DerbyScriptRunner.java</h1><pre class="source lang-java linenums">/* 
 * Copyright 2015 Development Entropy (deventropy.org) Contributors
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.deventropy.junithelper.derby;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.net.URL;
import java.nio.charset.Charset;
import java.sql.Connection;

import org.apache.commons.io.IOUtils;
import org.apache.derby.tools.ij;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.deventropy.shared.utils.ArgumentCheck;
import org.deventropy.shared.utils.UrlResourceUtil;

/**
 * Executes a SQL script on the given Derby embedded instance connection.
 * 
 * &lt;p&gt;The script uses a single character set for reading the scripts as well as writing the logs. The class has a
 * {@link #setDefaultScriptLogStream(OutputStream) Default Log Stream} which it uses when no log stream or file is
 * specified along with the script for execution ({@link #executeScript(String)}). A log stream may be specified with
 * the script resource using the {@link #executeScript(String, File)} or
 * {@link #executeScript(String, OutputStream, boolean)} methods.
 * 
 * &lt;p&gt;The script resources provided to this class should be in the format supported by {@link UrlResourceUtil}.
 * 
 * @author Bindul Bhowmik
 */
public class DerbyScriptRunner {
	
	/**
	 * Default system character set to use if none is specified by the user.
	 */
<span class="fc" id="L54">	public static final String DEFAULT_CHARSET = Charset.defaultCharset().name();</span>
	
<span class="fc" id="L56">	private final Logger log = LogManager.getLogger();</span>
	
	/**
	 * DB connection to use
	 */
	private final Connection dbConnection;
	
	/**
	 * Character set to use for this script runner
	 */
	private final String charset;
	
	/**
	 * Default script log stream if none is specified with the script.
	 */
	private OutputStream defaultScriptLogStream;
	
	/**
	 * Initializes a new script runner.
	 * 
	 * @param dbConnection The database connection to run the scripts on.
	 * @param charset Character set to use for reading the script and writing the log
	 */
<span class="fc" id="L79">	public DerbyScriptRunner (final Connection dbConnection, final String charset) {</span>
<span class="fc" id="L80">		this.dbConnection = dbConnection;</span>
<span class="fc" id="L81">		this.charset = charset;</span>
<span class="fc" id="L82">		this.defaultScriptLogStream = DerbyUtils.DEV_NULL;</span>
<span class="fc" id="L83">	}</span>
	
	/**
	 * Initializes a new script runner for the connection. Uses the {@link #DEFAULT_CHARSET} as the character set.
	 * 
	 * @param dbConnection The database connection to run the scripts on.
	 */
	public DerbyScriptRunner (final Connection dbConnection) {
<span class="fc" id="L91">		this(dbConnection, DEFAULT_CHARSET);</span>
<span class="fc" id="L92">	}</span>
	
	/**
	 * Sets the log stream to log results to. This can be overridden on a per script basis, and if not set defaults to
	 * {@link DerbyUtils#DEV_NULL} stream, which simply ignores all output.
	 * 
	 * &lt;p&gt;Data will be written to this stream using the character set set in the constructor.
	 * 
	 * @param defaultScriptLogStream The default script log stream
	 */
	public void setDefaultScriptLogStream (final OutputStream defaultScriptLogStream) {
<span class="fc" id="L103">		ArgumentCheck.notNull(defaultScriptLogStream, &quot;Default Script Log Stream&quot;);</span>
<span class="fc" id="L104">		this.defaultScriptLogStream = defaultScriptLogStream;</span>
<span class="fc" id="L105">	}</span>
	
	/**
	 * Executes the given script. The script run logs are written to the
	 * {@link #setDefaultScriptLogStream(OutputStream)}.
	 * 
	 * @param scriptResource The script source; should be in a format compatible with {@linkplain UrlResourceUtil}
	 * @return &lt;code&gt;0&lt;/code&gt; if the execution succeeds without any errors; &lt;code&gt;non zero&lt;/code&gt; value otherwise.
	 * @throws IOException Error reading script file, or writing to the log file.
	 */
	public int executeScript (final String scriptResource) throws IOException {
<span class="fc" id="L116">		return executeScript(scriptResource, defaultScriptLogStream, false);</span>
	}
	
	/**
	 * Executes the given script. The script run logs are written to the provided &lt;code&gt;scriptLogFile&lt;/code&gt;.
	 * 
	 * @param scriptResource The script source; should be in a format compatible with {@linkplain UrlResourceUtil}
	 * @param scriptLogFile The file to which the output logs are written. If the file already exists, it is appended to
	 * @return &lt;code&gt;0&lt;/code&gt; if the execution succeeds without any errors; &lt;code&gt;non zero&lt;/code&gt; value otherwise.
	 * @throws IOException Error reading script file, or writing to the log file.
	 */
	public int executeScript (final String scriptResource, final File scriptLogFile) throws IOException {
		try {
<span class="fc" id="L129">			final OutputStream scriptLogStream = new FileOutputStream(scriptLogFile, true);</span>
<span class="fc" id="L130">			return executeScript(scriptResource, scriptLogStream, true);</span>
<span class="fc" id="L131">		} catch (FileNotFoundException e) {</span>
<span class="fc" id="L132">			log.error(&quot;Error opening script log stream: {}&quot;, scriptLogFile);</span>
<span class="fc" id="L133">			throw new IOException(&quot;Error opening script log stream&quot;, e);</span>
		}
	}
	
	/**
	 * Executes the given script. The script run logs are written to the provided &lt;code&gt;scriptLogStream&lt;/code&gt;.
	 * 
	 * @param script The script source; should be in a format compatible with {@linkplain UrlResourceUtil}
	 * @param scriptLogStream The stream to which the output logs are written.
	 * @param closeScriptLogStream If set to &lt;code&gt;true&lt;/code&gt;, the log stream is closed at the end of the execution.
	 * @return &lt;code&gt;0&lt;/code&gt; if the execution succeeds without any errors; &lt;code&gt;non zero&lt;/code&gt; value otherwise.
	 * @throws IOException Error reading script file, or writing to the log file.
	 */
	public int executeScript (final String script, final OutputStream scriptLogStream,
			final boolean closeScriptLogStream) throws IOException {

<span class="fc" id="L149">		InputStream scriptStream = null;</span>

		try {

<span class="fc" id="L153">			final URL scriptUrl = UrlResourceUtil.getUrl(script);</span>
<span class="fc" id="L154">			scriptStream = scriptUrl.openStream();</span>
	
<span class="fc" id="L156">			log.debug(&quot;Executing script: {}&quot;, script);</span>
<span class="fc" id="L157">			final int exceptionCount = ij.runScript(dbConnection, scriptStream, charset,</span>
					scriptLogStream, charset);
<span class="fc bfc" id="L159" title="All 2 branches covered.">			if (exceptionCount &gt; 0) {</span>
<span class="fc" id="L160">				log.warn(&quot;Error executing script {}. See output for details&quot;, script);</span>
			}
<span class="fc" id="L162">			return exceptionCount;</span>

<span class="fc" id="L164">		} catch (UnsupportedEncodingException e) {</span>
<span class="fc" id="L165">			log.warn(&quot;Incompatible encoding for script file. Current characterset {0}&quot;, charset);</span>
<span class="fc" id="L166">			throw e;</span>
<span class="fc" id="L167">		} catch (IOException e) {</span>
<span class="fc" id="L168">			log.warn(&quot;Error opening or reading script file: {0}&quot;, script);</span>
<span class="fc" id="L169">			throw e;</span>
		} finally {
<span class="fc" id="L171">			IOUtils.closeQuietly(scriptLogStream);</span>
<span class="fc" id="L172">			IOUtils.closeQuietly(scriptStream);</span>
		}
	}
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>