<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmbeddedDerbyResource.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JUnit Helper :: Derby</a> &gt; <a href="index.source.html" class="el_package">org.deventropy.junithelper.derby</a> &gt; <span class="el_source">EmbeddedDerbyResource.java</span></div><h1>EmbeddedDerbyResource.java</h1><pre class="source lang-java linenums">/* 
 * Copyright 2015 Development Entropy (deventropy.org) Contributors
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.deventropy.junithelper.derby;

import java.io.Closeable;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.Properties;

import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.deventropy.junithelper.utils.ArgumentCheck;
import org.junit.rules.ExternalResource;
import org.junit.rules.TemporaryFolder;

/**
 * Provides an in-memory Derby resource. An instance of this class is initialized with the
 * {@link DerbyResourceConfig configuration} and a {@link #getDerbySystemHome() Derby System Home}.
 * 
 * &lt;p&gt;The class can be used either as a JUnit {@link org.junit.Rule Rule} / {@link org.junit.ClassRule ClassRule} OR
 * directly by the user. Initialization and de-initialization of an instance of this class (and the embedded Derby
 * instance) is handed by the {@link #start()} and {@link #close()} methods respectively. When used as a
 * &lt;code&gt;Rule&lt;/code&gt; or &lt;code&gt;ClassRule&lt;/code&gt;, the {@link #before()} and {@link #after()} mdthods from those interfaces
 * handle the initialization and de-initialization for the user (internally using the &lt;code&gt;#start()&lt;/code&gt; and
 * &lt;code&gt;#close()&lt;/code&gt; methods.
 * 
 * &lt;p&gt;Derby does not allow running multiple instances in the same JVM, so external protection should be provided to
 * protect against that.
 * 
 * &lt;p&gt;Example of usage:
 * &lt;pre&gt;
 * public class SimpleDerbyTest {
 * 
 * 	private TemporaryFolder tempFolder = new TemporaryFolder();
 * 	private EmbeddedDerbyResource embeddedDerbyResource =
 * 		new EmbeddedDerbyResource(DerbyResourceConfig.buildDefault().useDevNullErrorLogging(),
 * 		tempFolder);
 * 
 * 	&amp;#064;Rule
 * 	public RuleChain derbyRuleChain = RuleChain.outerRule(tempFolder).around(embeddedDerbyResource);
 * 
 * 	&amp;#064;Test
 * 	public void test () throws SQLException {
 * 		final String jdbcUrl = embeddedDerbyResource.getJdbcUrl();
 * 		Connection connection = null;
 * 		Statement stmt = null;
 * 		ResultSet rs = null;
 * 
 * 		try {
 * 			connection = DriverManager.getConnection(jdbcUrl);
 * 
 * 			// Check a value
 * 			stmt = connection.createStatement();
 * 			rs = stmt.executeQuery(&quot;SELECT 1 FROM SYSIBM.SYSDUMMY1&quot;);
 * 
 * 			assertTrue(rs.next());
 * 		} finally {
 * 			// Close resources
 * 		}
 * 	}
 * }
 * &lt;/pre&gt;
 * 
 * &lt;p&gt;For further information and examples, see
 * &lt;a href=&quot;http://www.deventropy.org/junit-helper/junit-helper-derby/manual/&quot;&gt;User Manual on the Project Website&lt;/a&gt;.
 * 
 * @author Bindul Bhowmik
 */
public class EmbeddedDerbyResource extends ExternalResource implements Closeable {

	private static final String PROP_FILE_DERBY_PROPERTIES = &quot;derby.properties&quot;;
	private static final String PROP_DERBY_SYSTEM_HOME = &quot;derby.system.home&quot;;
	private static final String PROP_DERBY_STREAM_ERROR_FILE = &quot;derby.stream.error.file&quot;;
	private static final String PROP_DERBY_STREAM_ERROR_FIELD = &quot;derby.stream.error.field&quot;;
	
	private static final String URLPROP_DERBY_CREATE = &quot;;create=true&quot;;
	private static final String URLPROP_DERBY_SHUTDOWN = &quot;;shutdown=true&quot;;
	private static final String URLPROP_DERBY_DROP = &quot;;drop=true&quot;;
	
	private static final String DERBY_EMBEDDED_DRIVER_CLASS = &quot;org.apache.derby.jdbc.EmbeddedDriver&quot;;
	
<span class="fc" id="L102">	private final Logger log = LogManager.getLogger();</span>
	
	private final DerbyResourceConfig config;
	private File derbySystemHome;
	private TemporaryFolder derbySystemHomeParent;
	
	private final String jdbcUrl;
	
	private String oldDerbySystemHomeValue;
	
	/**
	 * Creates a new Derby resource. All configurable parameters for this resource come from the config object
	 * passed in.
	 * 
	 * @param dbResourceConfig Configurations to setup this resource
	 * @param derbySystemHomeDir A folder to use as the derby system home
	 */
<span class="fc" id="L119">	public EmbeddedDerbyResource (final DerbyResourceConfig dbResourceConfig, final File derbySystemHomeDir) {</span>
<span class="fc" id="L120">		ArgumentCheck.notNull(dbResourceConfig, &quot;Embedded derby config&quot;);</span>
<span class="fc" id="L121">		this.config = dbResourceConfig;</span>
<span class="fc" id="L122">		ArgumentCheck.notNull(derbySystemHomeDir, &quot;Derby System Home Directory&quot;);</span>
<span class="fc" id="L123">		this.derbySystemHome = derbySystemHomeDir;</span>

<span class="fc" id="L125">		this.jdbcUrl = buildJdbcUrl();</span>
<span class="fc" id="L126">	}</span>
	
	/**
	 * Creates a new Derby resource. All configurable parameters for this resource come from the config object
	 * passed in.
	 * 
	 * @param dbResourceConfig Configurations to setup this resource
	 * @param derbySystemHomeParentTmpFolder A temporary folder to use as the derby system home
	 */
	public EmbeddedDerbyResource (final DerbyResourceConfig dbResourceConfig,
<span class="fc" id="L136">			final TemporaryFolder derbySystemHomeParentTmpFolder) {</span>

<span class="fc" id="L138">		ArgumentCheck.notNull(dbResourceConfig, &quot;Embedded derby config&quot;);</span>
<span class="fc" id="L139">		this.config = dbResourceConfig;</span>
<span class="fc" id="L140">		ArgumentCheck.notNull(derbySystemHomeParentTmpFolder, &quot;Derby System Home Parent Directory&quot;);</span>
		// This can be a TemporaryFolder, so make sure it is not touched before #before()
<span class="fc" id="L142">		this.derbySystemHomeParent = derbySystemHomeParentTmpFolder;</span>

<span class="fc" id="L144">		this.jdbcUrl = buildJdbcUrl();</span>
<span class="fc" id="L145">	}</span>
	
	private String buildJdbcUrl () {
		// TODO Check if this needs to be different for certain sub-sub protocols
<span class="fc" id="L149">		return new StringBuilder().append(config.getSubSubProtocol().jdbcConnectionPrefix())</span>
<span class="fc" id="L150">				.append(config.getDatabaseName()).toString();</span>
	}

	/* (non-Javadoc)
	 * @see org.junit.rules.ExternalResource#before()
	 */
	@Override
	protected void before () throws Throwable {
<span class="fc" id="L158">		super.before();</span>
<span class="fc" id="L159">		this.start();</span>
<span class="fc" id="L160">	}</span>
	
	/**
	 * Starts the Embedded derby instance.
	 * 
	 * &lt;p&gt;&lt;em&gt;Note:&lt;/em&gt; If using this instance as a JUnit {@linkplain org.junit.Rule}, do not call this method;
	 * initialization is already handled from the {@linkplain org.junit.rules.ExternalResource#before()}.
	 * 
	 * @throws IOException IO exception creating or setting derby home
	 * @throws SQLException SQL exception starting derby or running the init scripts
	 */
	public void start () throws IOException, SQLException {
		// Validate and setup
<span class="fc bfc" id="L173" title="All 2 branches covered.">		if (null != derbySystemHomeParent) {</span>
<span class="fc" id="L174">			this.derbySystemHome = derbySystemHomeParent.newFolder();</span>
		}
<span class="fc" id="L176">		FileUtils.forceMkdir(derbySystemHome);</span>
<span class="fc" id="L177">		oldDerbySystemHomeValue = System.getProperty(PROP_DERBY_SYSTEM_HOME); // Saving it to reset it later</span>
<span class="fc" id="L178">		System.setProperty(PROP_DERBY_SYSTEM_HOME, derbySystemHome.getAbsolutePath());</span>
<span class="fc" id="L179">		setupDerbyProperties();</span>

		// Start the database
		// Recommended Derby startup process,
		// see https://db.apache.org/derby/docs/10.12/publishedapi/org/apache/derby/jdbc/EmbeddedDriver.html
		try {
<span class="fc" id="L185">			Class.forName(DERBY_EMBEDDED_DRIVER_CLASS).newInstance();</span>
<span class="nc" id="L186">		} catch (InstantiationException | IllegalAccessException | ClassNotFoundException e) {</span>
			// Reset the Derby System Home property
<span class="nc" id="L188">			resetDerbyHome();</span>
<span class="nc" id="L189">			throw new SQLException(&quot;Unable to initialize Derby driver class: &quot; + DERBY_EMBEDDED_DRIVER_CLASS, e);</span>
<span class="fc" id="L190">		}</span>
		// Create / Connect to the database
<span class="fc" id="L192">		final Connection conn = DriverManager.getConnection(buildCreateJDBCUrl());</span>
		try {
			// Post init scripts
<span class="fc" id="L195">			executePostInitScripts(conn);</span>
		} finally {
<span class="fc" id="L197">			DerbyUtils.closeQuietly(conn);</span>
<span class="fc" id="L198">		}</span>
<span class="fc" id="L199">	}</span>

	private void executePostInitScripts (final Connection conn) throws IOException {
<span class="fc" id="L202">		final DerbyScriptRunner scriptRunner = new DerbyScriptRunner(conn);</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">		for (String postInitScript : config.getPostInitScripts()) {</span>
<span class="fc" id="L204">			final File scriptLogFile = new File(derbySystemHome, &quot;post-init-&quot;</span>
<span class="fc" id="L205">					+ postInitScript.replaceAll(&quot;/&quot;, &quot;_&quot;) + &quot;.log&quot;);</span>
			try {
<span class="fc" id="L207">				final int result = scriptRunner.executeScript(postInitScript, scriptLogFile);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">				if (result != 0) {</span>
<span class="fc" id="L209">					log.warn(FileUtils.readFileToString(scriptLogFile));</span>
<span class="fc" id="L210">					throw new IOException(&quot;Exceptions exist in script. See output for details&quot;);</span>
				}
<span class="fc" id="L212">			} catch (IOException e) {</span>
<span class="fc" id="L213">				log.warn(FileUtils.readFileToString(scriptLogFile));</span>
<span class="fc" id="L214">				throw new IOException(&quot;Exceptions exist in script. See output for details&quot;);</span>
<span class="fc" id="L215">			}</span>
<span class="fc" id="L216">		}</span>
<span class="fc" id="L217">	}</span>
	
	private String buildCreateJDBCUrl () {
		// TODO Will handle things here to restore from a backup, etc.
<span class="fc" id="L221">		return new StringBuilder().append(jdbcUrl).append(URLPROP_DERBY_CREATE).toString();</span>
	}

	private void setupDerbyProperties () throws IOException {
<span class="fc" id="L225">		final Properties derbyProps = new Properties();</span>

		// Logging
<span class="pc bfc" id="L228" title="All 2 branches covered.">		switch (config.getErrorLoggingMode()) {</span>
			case Null:
<span class="fc" id="L230">				derbyProps.setProperty(PROP_DERBY_STREAM_ERROR_FIELD, DerbyUtils.DEV_NULL_FIELD_ID);</span>
<span class="fc" id="L231">				break;</span>
			case Default:
			default:
<span class="fc" id="L234">				derbyProps.setProperty(PROP_DERBY_STREAM_ERROR_FILE, &quot;derby.log&quot;);</span>
				break;
		}

		// Write it
<span class="fc" id="L239">		final File derbyPropertyFile = new File(derbySystemHome, PROP_FILE_DERBY_PROPERTIES);</span>
<span class="fc" id="L240">		final FileWriter derbyPropertyFileWriter = new FileWriter(derbyPropertyFile);</span>
<span class="fc" id="L241">		derbyProps.store(derbyPropertyFileWriter, null);</span>
<span class="fc" id="L242">		IOUtils.closeQuietly(derbyPropertyFileWriter);</span>
<span class="fc" id="L243">	}</span>

	/* (non-Javadoc)
	 * @see org.junit.rules.ExternalResource#after()
	 */
	@Override
	protected void after () {
<span class="fc" id="L250">		super.after();</span>
		try {
<span class="fc" id="L252">			this.close();</span>
<span class="nc" id="L253">		} catch (IOException e) {</span>
			// Ignore
<span class="nc" id="L255">			log.catching(Level.TRACE, e);</span>
<span class="fc" id="L256">		}</span>
<span class="fc" id="L257">	}</span>

	/* (non-Javadoc)
	 * @see java.io.Closeable#close()
	 */
	@Override
	public void close () throws IOException {
<span class="fc" id="L264">		Connection conn = null;</span>
		try {
<span class="fc" id="L266">			final StringBuilder shutdownUrl = new StringBuilder(jdbcUrl);</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">			if (JdbcDerbySubSubProtocol.Memory == config.getSubSubProtocol()) {</span>
<span class="fc" id="L268">				shutdownUrl.append(URLPROP_DERBY_DROP);</span>
			} else {
<span class="nc" id="L270">				shutdownUrl.append(URLPROP_DERBY_SHUTDOWN);</span>
			}
<span class="nc" id="L272">			conn = DriverManager.getConnection(shutdownUrl.toString());</span>
<span class="fc" id="L273">		} catch (SQLException e) {</span>
			// Ignore - there will always be an exception
<span class="fc" id="L275">			log.catching(Level.TRACE, e);</span>
		} finally {
<span class="pc" id="L277">			DerbyUtils.closeQuietly(conn);</span>
<span class="pc" id="L278">		}</span>
		// Reset the Derby System Home property
<span class="fc" id="L280">		resetDerbyHome();</span>
<span class="fc" id="L281">	}</span>

	private void resetDerbyHome () {
		// Reset the Derby System Home property
<span class="pc bpc" id="L285" title="1 of 4 branches missed.">		if (null != oldDerbySystemHomeValue &amp;&amp; !oldDerbySystemHomeValue.isEmpty()) {</span>
<span class="fc" id="L286">			System.setProperty(PROP_DERBY_SYSTEM_HOME, oldDerbySystemHomeValue);</span>
<span class="fc" id="L287">			oldDerbySystemHomeValue = null;</span>
		} else {
<span class="fc" id="L289">			System.clearProperty(PROP_DERBY_SYSTEM_HOME);</span>
		}
<span class="fc" id="L291">	}</span>

	/**
	 * @return the derbySystemHome
	 */
	public File getDerbySystemHome () {
<span class="fc" id="L297">		return derbySystemHome;</span>
	}

	/**
	 * @return the jdbcUrl
	 */
	public String getJdbcUrl () {
<span class="fc" id="L304">		return jdbcUrl;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>